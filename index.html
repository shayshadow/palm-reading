<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WizPalm - Unveil Your Destiny</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Cinzel', 'Georgia', serif;
            background: radial-gradient(ellipse at top, #0f172a 0%, #020617 50%, #000000 100%);
            min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; color: white; overflow-x: hidden;
        }
        .scroll-container { background: linear-gradient(135deg, rgba(30, 58, 138, 0.9), rgba(55, 48, 163, 0.92)); border-radius: 20px; box-shadow: 0 0 60px rgba(59, 130, 246, 0.5); max-width: 750px; width: 100%; border: 2px solid rgba(147, 197, 253, 0.4); backdrop-filter: blur(10px); }
        .scroll-content { padding: 40px 30px; }
        h1 { text-align: center; color: #ddd6fe; font-size: 2.5em; margin-bottom: 30px; text-shadow: 0 0 20px rgba(147, 197, 253, 0.6); }
        .glass-section { background: rgba(59, 130, 246, 0.1); border: 2px solid rgba(147, 197, 253, 0.3); border-radius: 15px; padding: 20px; margin-bottom: 25px; }
        .palm-upload-card { background: rgba(30, 58, 138, 0.3); border: 2px solid rgba(59, 130, 246, 0.4); border-radius: 12px; padding: 20px; text-align: center; margin: 0 auto; max-width: 400px; }
        .upload-card-btn { display: flex; flex-direction: column; align-items: center; padding: 30px; border: 2px dashed rgba(147, 197, 253, 0.5); border-radius: 10px; cursor: pointer; transition: 0.3s; }
        .upload-card-btn.uploaded { background: rgba(34, 197, 94, 0.1); border-color: #4ade80; border-style: solid; }
        .btn { width: 100%; background: linear-gradient(135deg, #3b82f6, #6366f1); color: #fcd34d; border: 1px solid rgba(147, 197, 253, 0.5); padding: 15px; border-radius: 25px; cursor: pointer; font-weight: bold; font-family: inherit; margin-top: 15px; }
        .upload-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .upload-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(147,197,253,0.3); padding: 10px; border-radius: 10px; color: #bae6fd; cursor: pointer; }
        #resultArea { min-height: 100px; display: none; }
        .status-box { text-align: center; padding: 40px; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(147,197,253,0.2); border-top-color: #fcd34d; border-radius: 50%; animation: spin 1s infinite linear; margin: 0 auto 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-msg { color: #f87171; font-weight: bold; margin-bottom: 10px; }
        .mystic-summary { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; border-left: 4px solid #fcd34d; font-style: italic; line-height: 1.6; margin-bottom: 20px; }
        .lucky-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
        .lucky-item { background: rgba(59, 130, 246, 0.2); padding: 10px; border-radius: 10px; text-align: center; border: 1px solid rgba(147, 197, 253, 0.2); }
        .line-card { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 10px; }
        #chatbotArea { display: none; margin-top: 40px; border-top: 2px dashed rgba(147,197,253,0.3); padding-top: 30px; }
        .chat-box { height: 250px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 15px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(59, 130, 246, 0.3); }
        .msg { margin-bottom: 10px; padding: 10px 15px; border-radius: 12px; max-width: 85%; font-size: 0.9em; }
        .msg.bot { background: rgba(59, 130, 246, 0.3); color: #bae6fd; align-self: flex-start; }
        .msg.user { background: rgba(251, 191, 36, 0.2); color: #fcd34d; margin-left: auto; }
        video, canvas { width: 100%; max-width: 400px; border-radius: 15px; border: 3px solid #a78bfa; margin: 15px auto; display: none; }
        .question-input { width: 100%; padding: 12px 15px; border-radius: 20px; background: rgba(0,0,0,0.3); color: white; border: 2px solid rgba(147,197,253,0.4); outline: none; }
    </style>
</head>
<body>
<div class="scroll-container">
    <div class="scroll-content">
        <h1>WizPalm</h1>
        <div class="glass-section">
            <h3 style="text-align: center; color: #ddd6fe; margin-bottom: 15px;">Seek Thy Destiny</h3>
            <div style="display:flex; justify-content:center; margin-bottom: 20px;">
                <select id="genderSelect" onchange="updateUI()" style="padding:10px; border-radius:10px; background:#1e1b4b; color:white; border:1px solid #4f46e5; min-width:200px;">
                    <option value="none" selected disabled>--- Select Gender ---</option>
                    <option value="female">Female</option>
                    <option value="male">Male</option>
                    <option value="others">Others</option>
                </select>
            </div>
            <div id="palmCard" class="palm-upload-card" style="display:none;">
                <p id="guideText" style="color:#fcd34d; font-size:0.85em; margin-bottom:15px;"></p>
                <label for="palmUpload" class="upload-card-btn" id="palmLabel">
                    <span id="previewIcon" style="font-size:2em;">‚äï</span>
                    <span id="previewText">Upload Palm Image</span>
                </label>
                <input type="file" id="palmUpload" accept="image/*" onchange="handleFile(event)" style="display:none;">
                <canvas id="palmCanvas"></canvas>
            </div>
            <div id="uploadBtns" class="upload-options" style="display:none;">
                <button class="upload-btn" onclick="document.getElementById('palmUpload').click()">üìÅ File</button>
                <button class="upload-btn" onclick="startCamera()">üîÆ Camera</button>
            </div>
            <video id="video" autoplay playsinline></video>
            <div id="camControls" style="display:none; text-align:center;">
                <button class="btn" onclick="capture()">üì∏ Capture</button>
            </div>
            <button class="btn" id="analyzeBtn" onclick="runAnalysis()" style="display:none;">Reveal My Destiny</button>
        </div>
        <div id="resultArea" class="glass-section">
            <div id="loadingView" class="status-box" style="display:none;"><div class="spinner"></div><p>Reading the celestial rivers...</p></div>
            <div id="errorView" class="status-box" style="display:none;">
                <div style="font-size: 3em;">‚ö°</div>
                <p class="error-msg">Connection Severed!</p>
                <button class="btn" onclick="runAnalysis()">Retry Analysis</button>
            </div>
            <div id="reportView" style="display:none;">
                <h2 style="text-align:center; color:#fcd34d; margin-bottom:20px;">The Oracle's Decree</h2>
                <div id="mysticSummary" class="mystic-summary"></div>
                <div id="destinyMatch" style="background: rgba(251, 191, 36, 0.15); padding: 20px; border-radius: 12px; border: 1px solid rgba(251, 191, 36, 0.3); margin-bottom: 15px; text-align: center;"></div>
                <div id="luckyGrid" class="lucky-grid"></div>
                <div id="lineList"></div>
            </div>
        </div>
        <div id="chatbotArea">
            <h3 style="text-align:center; color:#ddd6fe; margin-bottom:15px;">Ask the Oracle</h3>
            <div id="chatBox" class="chat-box"><div class="msg bot">Thy destiny is laid bare. What else?</div></div>
            <div style="display:flex; gap:10px;"><input type="text" id="userInput" placeholder="Ask..." class="question-input" style="flex:1;"><button class="btn" onclick="sendChat()" style="margin:0; width:auto; padding:10px 20px;">‚ñ∂</button></div>
        </div>
    </div>
</div>

<script>
    let selectedImg = null;
    let stream = null;
    let ctxText = "";
    const API_BASE = "http://localhost:8080/api/palm";


    function updateUI() {
        const g = document.getElementById('genderSelect').value;
        document.getElementById('palmCard').style.display = 'block';
        document.getElementById('uploadBtns').style.display = 'grid';
        document.getElementById('guideText').innerText = g === 'female' ? "‚óà LEFT palm" : (g === 'male' ? "‚óà RIGHT palm" : "‚óà EITHER palm");
    }


    async function startCamera() {
        try {
            const v = document.getElementById('video');
            v.style.display = 'block';
            document.getElementById('camControls').style.display = 'block';
            document.getElementById('palmCanvas').style.display = 'none'; // Ïù¥Ï†Ñ ÏÇ¨ÏßÑ Ïà®Í∏∞Í∏∞
            document.getElementById('palmLabel').style.display = 'none'; // ÏóÖÎ°úÎìú ÏïÑÏù¥ÏΩò ÏùºÏãú Ïà®Í∏∞Í∏∞

            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            v.srcObject = stream;
        } catch (err) {
            alert("Camera access denied.");
        }
    }

    function capture() {
        const v = document.getElementById('video');
        const c = document.getElementById('palmCanvas');
        const ctx = c.getContext('2d');


        c.width = v.videoWidth;
        c.height = v.videoHeight;


        ctx.drawImage(v, 0, 0);

        selectedImg = c.toDataURL('image/jpeg');

        c.style.display = 'block'; // üí° Ï∫îÎ≤ÑÏä§ Î≥¥Ïù¥Í≤å ÏÑ§Ï†ï (ÌïµÏã¨!)
        v.style.display = 'none';
        document.getElementById('camControls').style.display = 'none';
        document.getElementById('palmLabel').style.display = 'flex'; // Îã§Ïãú ÏïÑÏù¥ÏΩò ÏòÅÏó≠ Î≥¥Ïù¥Í≤å Ìï®

        if (stream) stream.getTracks().forEach(t => t.stop());

        finishUploadUI();
    }


    function handleFile(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            selectedImg = ev.target.result;
            showPreview(selectedImg);
        };
        reader.readAsDataURL(file);
    }


    function showPreview(url) {
        const c = document.getElementById('palmCanvas');
        const img = new Image();
        img.onload = () => {
            c.width = img.width;
            c.height = img.height;
            const ctx = c.getContext('2d');
            ctx.drawImage(img, 0, 0);
            c.style.display = 'block'; // üí° Ï∫îÎ≤ÑÏä§ Î≥¥Ïù¥Í≤å ÏÑ§Ï†ï
            finishUploadUI();
        };
        img.src = url;
    }


    function finishUploadUI() {
        document.getElementById('palmLabel').classList.add('uploaded');
        document.getElementById('previewIcon').innerText = "‚úì";
        document.getElementById('previewText').innerText = "Palm Identified";
        document.getElementById('analyzeBtn').style.display = 'block';
    }


    function stopCamera() {
        if (stream) stream.getTracks().forEach(t => t.stop());
        document.getElementById('video').style.display = 'none';
        document.getElementById('camControls').style.display = 'none';
        document.getElementById('palmLabel').style.display = 'flex';
    }

    async function runAnalysis() {
        if (!selectedImg) return;
        const btn = document.getElementById('analyzeBtn');
        btn.disabled = true; btn.innerText = "Consulting the Stars...";


        document.getElementById('resultArea').style.display = 'block';
        document.getElementById('loadingView').style.display = 'block';
        document.getElementById('errorView').style.display = 'none';
        document.getElementById('reportView').style.display = 'none';
        document.getElementById('resultArea').scrollIntoView({ behavior: 'smooth' });

        try {
            const blob = await (await fetch(selectedImg)).blob();
            const formData = new FormData();
            formData.append("palm", blob, "palm.jpg");
            formData.append("gender", document.getElementById('genderSelect').value);

            const res = await fetch(`${API_BASE}/analyze`, { method: "POST", body: formData });
            if (!res.ok) throw new Error("Network Error");

            const data = await res.json();
            document.getElementById('loadingView').style.display = 'none';


            if (data.status === "OK" || data.status === "SUCCESS") {
                ctxText = JSON.stringify(data);
                renderResults(data);
                document.getElementById('reportView').style.display = 'block';
                document.getElementById('chatbotArea').style.display = 'block';

            }

            else if (data.status === "ERROR") {
                showHandError("Unable to identify the palm. (The image may be oriented incorrectly or is not identifiable as a palm.)");
            }
        } catch (e) {

            document.getElementById('loadingView').style.display = 'none';
            showHandError("The cosmic connection was severed! (Check your server or internet.)");
        } finally {
            btn.disabled = false; btn.innerText = "Reveal My Destiny";
        }
    }


    function showHandError(msg) {
        const errorView = document.getElementById('errorView');
        errorView.style.display = 'block';
        errorView.querySelector('.error-msg').innerText = "Unable to recognize the palm.\n" +
            "(The uploaded image may be in an incorrect orientation or may not contain a recognizable palm.)";
        errorView.querySelector('.retry-text').innerText = msg;
    }


    function renderResults(data) {
        document.getElementById('mysticSummary').innerText = `"${data.mysticSummary}"`;
        document.getElementById('destinyMatch').innerHTML = `
            <div style="color:#fcd34d; font-size:1.4em; font-weight:bold;">${data.destinyMatch.archetype}</div>
            <p style="color:#bae6fd; margin-top:10px;">${data.destinyMatch.meaning}</p>`;
        document.getElementById('luckyGrid').innerHTML = `
            <div class="lucky-item">Color: ${data.luckyContext.luckyColor}</div>
            <div class="lucky-item">Number: ${data.luckyContext.luckyNumber}</div>
            <div class="lucky-item">Animal: ${data.luckyContext.powerAnimal}</div>
            <div class="lucky-item">Action: ${data.luckyContext.actionItem}</div>`;
        document.getElementById('lineList').innerHTML = Object.entries(data.lines).map(([k, v]) => `
            <div class="line-card"><strong>‚ú¶ ${k.toUpperCase()}</strong><p style="font-size:0.85em; color:#bae6fd;">${v.description}</p></div>`).join('');
    }

    async function sendChat() {
        const input = document.getElementById('userInput');
        const txt = input.value.trim(); if (!txt) return;
        addMsg('user', txt); input.value = '';
        try {
            const res = await fetch(`${API_BASE}/chat`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userMessage: txt, analysisContext: ctxText })
            });
            const data = await res.json();
            addMsg('bot', data.answer);
        } catch (e) { addMsg('bot', "The stars are silent."); }
    }

    function addMsg(role, content) {
        const b = document.getElementById('chatBox');
        const d = document.createElement('div');
        d.className = `msg ${role}`; d.innerText = content;
        b.appendChild(d); b.scrollTop = b.scrollHeight;
    }
    document.getElementById('userInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendChat(); });
</script>
</body>
</html>